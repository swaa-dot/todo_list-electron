<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>Todo List</title>
    <link rel="stylesheet" href="./style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>

<body>
    <div class="container">
        <h1><i class="fas fa-tasks"></i> Todo List</h1>

        <div class="input-container">
            <input type="text" id="todoInput" placeholder="Add a new task...">

            <!-- Category dropdown -->
            <select id="categorySelect">
                <option value="">--Select Category--</option>
            </select>

            <!-- Tags multi-select -->
            <div id="tagCheckboxes"></div>

            <button id="addBtn"><i class="fas fa-plus"></i> Add</button>
        </div>

        <ul id="todoList"></ul>
    </div>

    <!-- Modal untuk detail todo -->
    <div id="detailModal" class="modal">
        <div class="modal-content">
            <span class="close-modal">&times;</span>
            <h2>Todo Details</h2>
            <div id="modalContent">
                <!-- Detail akan dimuat di sini -->
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const todoInput = document.getElementById('todoInput');
            const addBtn = document.getElementById('addBtn');
            const todoList = document.getElementById('todoList');
            const categorySelect = document.getElementById('categorySelect');
            const modal = document.getElementById('detailModal');
            const modalContent = document.getElementById('modalContent');
            const closeModal = document.querySelector('.close-modal');

            // Load todos from database
            await loadTodos();

            // Add new Todos
            addBtn.addEventListener('click', addTodo);
            todoInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') addTodo();
            });

            // Modal close handlers
            closeModal.addEventListener('click', () => {
                modal.style.display = 'none';
            });

            window.addEventListener('click', (event) => {
                if (event.target === modal) {
                    modal.style.display = 'none';
                }
            });

            async function loadTodos() {
                const todos = await window.electronAPI.getTodos();
                todoList.innerHTML = '';
                todos.forEach(todo => {
                    renderTodoItem(todo);
                });
            }

            function renderTodoItem(todo) {
                const li = document.createElement('li');
                li.className = todo.completed ? 'completed' : '';
                li.dataset.id = todo.id;

                const categoryDisplay = todo.category ? `<span class="todo-category" style="background-color: #e1f5fe; padding: 2px 6px; border-radius: 4px; 
                margin-right: 5px;">${todo.category.name}</span>` : '';

                const tagsDisplay = todo.tags && todo.tags.length > 0
                    ? `<div class="todo-tags">${todo.tags.map(tag =>
                        `<span class="todo-tag" style="background-color: #e8f5e9; padding: 2px 6px; border-radius: 4px; margin-right: 5px; font-size: 0.8em;">${tag.name}</span>`
                    ).join(' ')}</div>`
                    : '';

                li.innerHTML = `
                 <div class="task-container">
            ${categoryDisplay}
                    <span class="task-text">${todo.task}</span>
                    <div class="actions">
                        <i class="fas fa-info-circle detail-btn" title="View Details"></i>
                        <i class="fas fa-edit edit-btn"></i>
                        <i class="fas ${todo.completed ? 'fa-undo' : 'fa-check'} toggle-btn" title="${todo.completed ? 'Mark Incomplete' : 'Mark Complete'}"></i>
                        <i class="fas fa-trash delete-btn"></i>
                    </div>
                    <input type="text" class="edit-input" value="${todo.task}" style="display: none;">
                    ${tagsDisplay}
                    `;

                todoList.appendChild(li);

                // Element references
                const detailBtn = li.querySelector('.detail-btn');
                const taskText = li.querySelector('.task-text');
                const editInput = li.querySelector('.edit-input');
                const editBtn = li.querySelector('.edit-btn');
                const deleteBtn = li.querySelector('.delete-btn');
                const toggleBtn = li.querySelector('.toggle-btn');

                // Detail functionality
                detailBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    showTodoDetails(todo);
                });

                // Edit functionality
                editBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    startEditing(li, taskText, editInput);
                });
                editInput.addEventListener('keypress', async (e) => {
                    if (e.key === 'Enter') {
                        const newTask = editInput.value.trim();
                        if (newTask && newTask !== todo.task) {
                            const success = await window.electronAPI.updateTodo(todo.id, newTask);
                            if (success) {
                                todo.task = newTask;
                                taskText.textContent = newTask;
                            }
                        }
                        stopEditing(li, taskText, editInput);
                    }
                });
                editInput.addEventListener('blur', () => {
                    stopEditing(li, taskText, editInput);
                });

                // Delete functionality
                deleteBtn.addEventListener('click', async (e) => {
                    e.stopPropagation();
                    const success = await window.electronAPI.deleteTodo(todo.id);
                    if (success) li.remove();
                });

                // Toggle functionality
                toggleBtn.addEventListener('click', async (e) => {
                    e.stopPropagation();
                    const newStatus = !todo.completed;
                    const success = await window.electronAPI.toggleTodo(todo.id, newStatus);
                    if (success) {
                        todo.completed = newStatus;
                        li.className = todo.completed ? 'completed' : '';
                        toggleBtn.className = `fas ${todo.completed ? 'fa-undo' : 'fa-check'} toggle-btn`;
                    }
                });
            }

            function showTodoDetails(todo) {
                const modal = document.getElementById('detailModal');
                const modalContent = document.getElementById('modalContent');

                const createdAt = todo.createdAt ? new Date(todo.createdAt).toLocaleString() : 'N/A';
                const updatedAt = todo.updatedAt ? new Date(todo.updatedAt).toLocaleString() : 'N/A';

                const categoryInfo = todo.category
                    ? `<div class="detail-item">
                    <span class="detail-label">Category: </span>
                    <span class="detail-value">${todo.category.name}</span>
                    </div>` : '';

                const tagsInfo = todo.tags && todo.tags.length > 0
                    ? `<div class="detail-item">
                        <span class="detail-label">Tags:</span>
                        <span class="detail-value">${todo.tags.map(tag => tag.name).join(', ')}</span>
                        </div>`
                    : '';

                modalContent.innerHTML = `
                    <div class="detail-item">
                        <span class="detail-label">Task:</span>
                        <span class="detail-value">${todo.task}</span>
                        </div>
                    ${categoryInfo}
                    ${tagsInfo}
                    <div class="detail-item">
                        <span class="detail-label">Status:</span>
                        <span class="detail-value">${todo.completed ? 'Completed' : 'Pending'}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Created: </span>
                            <span class="detail-value">${createdAt}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Updated: </span>
                            <span class="detail-value">${updatedAt}</span>
                        </div>`;

                modal.style.display = 'block';
            }

            function startEditing(li, taskText, editInput) {
                taskText.style.display = 'none';
                editInput.style.display = 'block';
                editInput.focus();
                editInput.select();
                li.classList.add('editing');
            }

            function stopEditing(li, taskText, editInput) {
                taskText.style.display = 'block';
                editInput.style.display = 'none';
                li.classList.remove('editing');
            }

            async function loadCategoriesAndTags() {
                const categories = await window.electronAPI.getCategories();

                categorySelect.innerHTML = '<option value="">--Select Category--</option>';
                categories.forEach(cat => {
                    const opt = document.createElement('option');
                    opt.value = cat.id;
                    opt.textContent = cat.name;
                    categorySelect.appendChild(opt);
                });

                const tagContainer = document.getElementById('tagCheckboxes');
                const tags = await window.electronAPI.getTags();
                tagContainer.innerHTML = '';
                tags.forEach(tag => {
                    const label = document.createElement('label');
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.name = 'tags';
                    checkbox.value = tag.id;

                    label.appendChild(checkbox);
                    label.appendChild(document.createTextNode(' ' + tag.name));
                    tagContainer.appendChild(label);
                    tagContainer.appendChild(document.createElement('br'));
                });
            }

            // Panggil saat DOM loaded
            await loadCategoriesAndTags();

            async function addTodo() {
                const task = todoInput.value.trim();
                const categoryId = categorySelect.value;
                const selectedTags = Array.from(document.querySelectorAll('#tagCheckboxes input[type="checkbox"]:checked'))
                    .map(cb => cb.value);

                if (!task) return;

                const success = await window.electronAPI.addTodoWithCategoryAndTags(task, categoryId, selectedTags);
                if (success) {
                    todoInput.value = '';
                    categorySelect.value = '';
                    document.querySelectorAll('#tagCheckboxes input[type="checkbox"]').forEach(cb => cb.checked = false);
                    await loadTodos();
                }
            }
        });
    </script>
</body>

</html>